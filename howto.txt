# Log in to Azure (if not already logged in)
az login

# Set variables (adjust as needed)
SUBSCRIPTION_ID="your-subscription-id"
RESOURCE_GROUP="terraform-state-rg-patrick"
LOCATION="West Europe"
IDENTITY_NAME="GitHubActionsIdentity"
GITHUB_ORG="PatrickDegner"
GITHUB_REPO="terraform_azure"
ENVIRONMENT_NAME="production"
FEDERATED_CREDENTIAL_NAME="GitHubActionsIdentityCred"

# Set the subscription
az account set --subscription $SUBSCRIPTION_ID

# Create the resource group if it doesn't exist
az group create --location $LOCATION --name $RESOURCE_GROUP

# Create the user-assigned managed identity if it doesn't exist
az identity create --name $IDENTITY_NAME --resource-group $RESOURCE_GROUP --location $LOCATION

# Get the Principal ID of the managed identity
PRINCIPAL_ID=$(az identity show --name $IDENTITY_NAME --resource-group $RESOURCE_GROUP --query principalId --output tsv)

# Get the ID of the resource group
RESOURCE_GROUP_ID=$(az group show --name $RESOURCE_GROUP --query id --output tsv)

# Assign the "Contributor" role to the managed identity at the resource group scope
az role assignment create --assignee-object-id $PRINCIPAL_ID --assignee-principal-type ServicePrincipal --role "Contributor" --scope $RESOURCE_GROUP_ID

# Assign the "Storage Blob Data Contributor" role to the managed identity at the resource group scope
az role assignment create --assignee-object-id $PRINCIPAL_ID --assignee-principal-type ServicePrincipal --role "Storage Blob Data Contributor" --scope $RESOURCE_GROUP_ID

# Create the federated identity credential
az identity federated-credential create \
  --name $FEDERATED_CREDENTIAL_NAME \
  --identity-name $IDENTITY_NAME \
  --resource-group $RESOURCE_GROUP \
  --issuer "https://token.actions.githubusercontent.com" \
  --subject "repo:${GITHUB_ORG}/${GITHUB_REPO}:environment:${ENVIRONMENT_NAME}" \
  --audiences "api://AzureADTokenExchange"
